
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Blip">
  <link rel="apple-touch-icon" href="Blip Logo Design.png">
  <title>Blip V0.02</title>
  <style>
    #moooodsContainer > div {
  scroll-snap-align: start;
}
.story-upload {
  background: white;
  padding: 16px;
  margin: 16px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  max-width: 500px;
  margin-inline: auto;
}

.story-upload h3 {
  margin-top: 0;
  font-size: 18px;
  color: #333;
}

.story-upload input[type="file"] {
  margin: 8px 0;
  padding: 10px;
  width: 100%;
  border: 1px solid #ccc;
  border-radius: 8px;
  background: #f9f9f9;
}

.story-upload input[type="text"] {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  margin-bottom: 12px;
}

.story-upload button {
  width: 100%;
  padding: 12px;
  background-color: #1877f2;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.story-upload button:hover {
  background-color: #145ddc;
}

    .comment-popup {
    display: none;
    position: fixed;
    bottom: 60px;
    left: 50%;
    transform: translateX(-50%);
    width: 95%;
    max-width: 420px;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    padding: 16px;
    z-index: 9999;
    animation: popupSlide 0.3s ease;
    font-family: 'Segoe UI', sans-serif;
  }

  @keyframes popupSlide {
    from { transform: translateX(-50%) translateY(20px); opacity: 0; }
    to { transform: translateX(-50%) translateY(0); opacity: 1; }
  }

  .comment-popup h3 {
    margin: 0 0 12px;
    font-size: 18px;
    color: #333;
  }

  #commentsList > div {
    padding: 10px;
    background: #f5f5f5;
    margin-bottom: 8px;
    border-radius: 8px;
    font-size: 15px;
    color: #222;
  }

  .comment-popup textarea {
    width: 100%;
    height: 60px;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 10px;
    resize: none;
    font-size: 14px;
    margin-top: 8px;
    box-sizing: border-box;
  }

  .comment-popup button {
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    background-color: #1877f2;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    font-size: 15px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  #groupAppScreen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      z-index: 99999;
      overflow: auto;
    }
    #groupChat {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 20px;
    }
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }
    #chatInput {
      display: flex;
    }
    #chatInput input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
    }
    #chatInput button {
      padding: 10px;
      background: #1877f2;
      color: white;
      border: none;
    }
  .comment-popup button:hover {
    background-color: #145ddc;
  }
    /* Make everything scale on small screens */
* {
  box-sizing: border-box;
}
.mood-media {
  width: 100vw;
  height: 100vh;
  object-fit: contain;
  display: block;
  background: black;
}

body {
  margin: 0;
  font-family: sans-serif;
  background: #f2f2f2;
  overflow-x: hidden;
}
#moooodsContainer {
  scroll-snap-type: y mandatory;
  overflow-y: scroll;
  height: 100vh;
}

#moooodsContainer > div {
  scroll-snap-align: start;
}

.header, .new-post, .feed, .stories, .rings, #profileEditor, .page {
  max-width: 100%;
  width: 100%;
}
.file-upload-btn {
  display: inline-block;
  background-color: #1877f2;
  color: white;
  padding: 10px 16px;
  font-size: 15px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.file-upload-btn:hover {
  background-color: #145ddc;
}

/* Make layout stack vertically on small screens */
@media screen and (max-width: 768px) {
  .header, .new-post {
    flex-direction: column;
    align-items: flex-start;
  }

  .header {
    font-size: 20px;
    padding: 12px;
  }

  .new-post input[type="text"] {
    width: 100%;
    margin-bottom: 8px;
  }

  .new-post input[type="file"], 
  .new-post button {
    width: 100%;
  }
}

/* Feed post image responsiveness */
.post img.post-img {
  width: 100%;
  height: auto;
  max-height: 500px;
  object-fit: contain;
  border-radius: 10px;
}

/* Responsive profile editor modal */
#profileEditor {
  width: 90%;
  max-width: 400px;
}
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  z-index: 9998;
}

.popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.95);
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.2);
  width: 90%;
  max-width: 400px;
  display: none;
  z-index: 9999;
  transition: transform 0.2s ease, opacity 0.2s ease;
}

.popup.show {
  display: block;
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}

.popup input, .popup button {
  width: 100%;
  padding: 10px;
  margin: 8px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.popup button {
  background: #1877f2;
  color: white;
  font-weight: bold;
  cursor: pointer;
}

/* Scrollable rings and stories */
.rings, .stories {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

/* Hash tags clickable */
.hashtag {
  color: #1877f2;
  cursor: pointer;
  font-weight: bold;
}
n
/* Search input styling */
#searchInput {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin: 10px auto;
  max-width: 500px;
  display: block;
}
.post-carousel {
  display: flex;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  width: 100%;
  max-width: 100%;
  border-radius: 10px;
  scroll-behavior: smooth;
}
.story-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(1);
  background: white;
  border-radius: 12px;
  overflow: hidden;
  z-index: 9999;
  width: 90%;
  max-width: 360px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.25);
  display: none;
  flex-direction: column;
  padding: 0;
  animation: popupSlideIn 0.3s ease;
}

@keyframes popupSlideIn {
  from { transform: translate(-50%, -60%) scale(0.95); opacity: 0; }
  to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}

.preview {
  background: #000;
  height: 300px;
  position: relative;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  overflow: hidden;
}

.preview img,
.preview video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  position: absolute;
}

.caption-overlay {
  position: relative;
  z-index: 2;
  background: rgba(0,0,0,0.6);
  color: white;
  padding: 8px 12px;
  margin: 12px;
  border-radius: 8px;
  font-size: 14px;
  max-width: 80%;
  text-align: center;
}

.story-popup input[type="file"],
.story-popup input[type="text"] {
  width: 90%;
  margin: 12px auto;
  display: block;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
}

.story-popup-buttons {
  display: flex;
  justify-content: space-around;
  padding: 12px;
  border-top: 1px solid #eee;
  background: #fafafa;
}

.story-popup-buttons button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  background: #1877f2;
  color: white;
}

.story-popup-buttons .cancel {
  background: #ccc;
  color: black;
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  z-index: 9998;
}

.post-carousel img {
  flex: 0 0 100%;
  width: 100%;
  object-fit: cover;
  scroll-snap-align: center;
  border-radius: 10px;
}

/* User pic icon */
#user-pic img {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  object-fit: cover;
}

    .hashtag {
  color: #1877f2;
  cursor: pointer;
}
.hashtag:hover {
  text-decoration: underline;
}
.stats span {
  margin-right: 10px;
}

    .top-bar {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: white;
  margin-bottom: 10px;
}
.top-bar .search-container {
  flex: 1;
  min-width: 200px;
}
.top-bar .new-post {
  flex: 2;
  display: flex;
  gap: 10px;
  align-items: center;
}
.top-bar input[type="text"],
.top-bar input[type="file"] {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 8px;
  flex: 1;
}
.top-bar button {
  padding: 10px;
  background: #1877f2;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.meta strong img {
  vertical-align: middle;
  border-radius: 50%;
}

.comment-popup {
      display: none;
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
      z-index: 9999;
    }
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f2f2f2;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: white;
      font-weight: bold;
      font-size: 24px;
    }

    .rings, .stories {
      display: flex;
      gap: 10px;
      padding: 10px;
      overflow-x: auto;
      background: white;
    }
.meta strong {
  display: flex;
  align-items: center;
}
.story-viewer {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: black;
  z-index: 99999;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}

.story-viewer video,
.story-viewer img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

.story-caption {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 10px 16px;
  border-radius: 10px;
  font-size: 16px;
  max-width: 80%;
  text-align: center;
}

.meta strong img.verified-icon {
  width: 16px;
  height: 16px;
  margin-left: 4px;
  vertical-align: middle;
}

    .story-ring, .story {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }

    .story img, .story-ring img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .story-ring.blue { border: 3px solid #1877f2; }
    .story-ring.red { border: 3px solid red; }
    .story-ring.orange { border: 3px solid orange; }
    .story-ring.purple { border: 3px solid purple; }

    .story .username {
      position: absolute;
      bottom: -20px;
      font-size: 12px;
      text-align: center;
      width: 100%;
    }

    .new-post {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: white;
    }

    .new-post input[type="text"] {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    #sharePopup.show {
  display: block !important;
  opacity: 1 !important;
  transform: translate(-50%, -50%) scale(1) !important;
}
    .hellnah{
      padding: 10px;
      background: #1877f2;
      color: white;
      border: none;
      border-radius: 8px;
    }
    .new-post button {
      padding: 10px;
      background: #1877f2;
      color: white;
      border: none;
      border-radius: 8px;
    }

    .feed {
      padding: 10px;
    }
   
    
  #sharePopup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    background: white;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
    z-index: 100000;
    opacity: 0;
    transition: all 0.25s ease;
  }

  #sharePopup.show {
    display: block !important;
    opacity: 1 !important;
    transform: translate(-50%, -50%) scale(1) !important;
  }


    .post {
      background: white;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .post-img {
  width: 100%;
  max-height: 600px;
  object-fit: cover;
  border-radius: 10px;
}
.hashtag {
  color: #1877f2;
  cursor: pointer;
  font-weight: bold;
}
input[type="file"]::file-selector-button {
  padding: 10px;
  background: #1877f2;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s ease;
}

input[type="file"]::file-selector-button:hover {
  background: #145ddc;
}

    .post img.post-img {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }

    .meta {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .meta img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
    }
    .post-img {
  width: 100%;
  max-width: 100%;
  max-height: 400px;
  object-fit: contain;
  display: block;
  margin: 10px auto 0;
  border-radius: 10px;
  background: #fff;
}
.verified-icon {
  width: 16px;
  height: 16px;
  margin-left: 4px;
  vertical-align: middle;
}
.carousel {
  overflow-x: scroll;
  display: flex;
  gap: 10px;
  margin-top: 10px;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
}

.carousel-track {
  display: flex;
  gap: 10px;
}

.carousel-img {
  width: 100%;
  max-width: 100%;
  height: 300px;
  object-fit: cover;
  border-radius: 10px;
  scroll-snap-align: center;
}

    .stats {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 14px;
      color: gray;
    }

    .like-btn {
      cursor: pointer;
      color: gray;
    }

    .like-btn.liked {
      color: red;
    }

    .comment-btn {
      cursor: pointer;
      color: #1877f2;
      margin-left: 10px;
    }

    .follow-btn, #logoutBtn {
      margin: 10px 0;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .follow-btn {
      background: #1877f2;
      color: white;
    }

    #logoutBtn {
      background: red;
      color: white;
      font-size: 14px;
    }

    #picPreview {
      max-width: 100px;
      border-radius: 50%;
      margin-bottom: 10px;
      display: none;
    }

    .page { display: none; }
    
    #profileEditor {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      z-index: 999;
      width: 80%;
      max-width: 400px;
    }
    
    #profileEditor input,
    #profileEditor textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 998;
      display: none;
    }
    .delete-btn {
  margin-left: auto;
  cursor: pointer;
  color: red;
  font-size: 18px;
}

  </style>
</head>
<body>

  <div class="header">
    <span>‚ò∞</span> Blip
    <div>
      <span id="user-pic" onclick="openEditor()" style="cursor:pointer;"></span>
      <button id="logoutBtn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="rings" id="storyRings"></div>
  <div class="stories" id="stories"></div>

  <!-- Upload Story -->
  <div id="bottomNav" style="
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 60px;
  background: #ffffff;
  border-top: 1px solid #ccc;
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 9999;
">
  <img src="Untitled design (1).svg" onclick="goToFeed()" style="height: 30px; cursor: pointer;">
  <img src="Untitled design (2).svg" onclick="openMoooods()" style="height: 30px; cursor: pointer;">
</div>

  <!-- Profile Editor Modal -->
  <div class="overlay" id="editorOverlay"></div>
  <div id="profileEditor">
    <h2>Edit Profile</h2>
    <input id="editName" type="text" placeholder="Username">
    <textarea id="editBio" placeholder="Bio"></textarea>
    <input type="file" id="editPic" accept="image/*"><br><br>
    <button onclick="saveProfileEdits()">Save</button>
    <button onclick="closeEditor()">Cancel</button>
  </div>
  <div class="mutual-followers" id="mutual-${postId}" style="font-size: 13px; color: #777; margin-left: 50px;"></div>
  <div id="loginSection" style="text-align:center; margin:20px; display:none;">
    <button onclick="loginWithGoogle()" style="padding:10px 20px; background:#1877f2; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
      Sign in with Google
    </button>
  </div>
  
  <!-- Create Post -->
  <div class="new-post">
    <input id="postInput" placeholder="What's on your mind?" type="text">
    
    <input type="file" id="postImage" accept="image/*,video/*" multiple onchange="validateImageLimit(this)">
    
    <script>
    function validateImageLimit(input) {
      if (input.files.length > 10) {
        alert("You can only upload up to 10 images.");
        input.value = ""; // Clear selection
      }
    }
    </script>

<button onclick="openStoryPopup()" style="margin: 10px; padding: 10px 20px; background: #1877f2; color: white; border: none; border-radius: 8px; font-weight: bold;">+ Add Story</button>

<div id="storyPopupOverlay" class="overlay" onclick="closeStoryPopup()"></div>

<div id="storyPopup" class="story-popup">
  <div class="preview" id="storyPreview">
    <span class="caption-overlay" id="previewCaption"></span>
  </div>
  
  <input type="file" id="storyFile" accept="image/*,video/*" onchange="previewStoryMedia(event)">
  <input type="text" id="storyOverlay" placeholder="Write a caption..." oninput="updateCaptionPreview()">
  
  <div class="story-popup-buttons">
    <button onclick="uploadStory()">Upload</button>
    <button onclick="closeStoryPopup()" class="cancel">Cancel</button>
  </div>
</div>



    <button onclick="createPost()">Post</button>
  </div>
  <div class="new-post" style="margin-top: 0; border-top: 1px solid #ddd;">
    <input id="searchInput" type="text" placeholder="Search #hashtags or words..." oninput="searchPosts()" />
  </div>
  
  <div class="feed" id="feed"></div>

  <div id="moooodsScreen" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:99999;overflow:hidden;">
    <button onclick="closeMoooods()" style="position:absolute;top:10px;right:10px;padding:10px;background:red;color:white;border:none;border-radius:50%;">‚úñ</button>
    <div id="moooodsContainer" style="height:100%;overflow-y:scroll;scroll-snap-type:y mandatory;"></div>
    <div style="position:absolute;right:10px;bottom:50px;display:flex;flex-direction:column;align-items:center;gap:20px;">
     
      <div id="bottomNav" style="
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 60px;
  background: #ffffff;
  border-top: 1px solid #ccc;
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 9999;
">
  <img src="Untitled design (1).svg" onclick="goToFeed()" style="height: 30px; cursor: pointer;">
  <img src="Untitled design (2).svg" onclick="openMoooods()" style="height: 30px; cursor: pointer;">
</div>
    </div>
    
  
    </div>
  </div>
  <!-- Profile Page -->
  <div class="page" id="profilePage" style="padding: 20px;">
    <span onclick="closeProfile()" style="cursor:pointer; font-size:18px;">‚Üê Back</span>
    <h2 id="profileName"></h2>
    <p id="profileBio"></p>
    <p><span id="followerCount">0</span> Followers</p>
    <button id="followBtn" class="follow-btn" onclick="toggleFollow()">Follow</button>
    <div id="profilePosts"></div>
  </div>
  
  <div id="sharePopup">
    <p style="margin-bottom: 15px; font-weight: bold;">Share this post</p>
    <button onclick="copyShareLink()" style="padding:10px 20px; background:#1877f2; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Copy Link</button>
    <button onclick="closeSharePopup()" style="margin-top:10px; display:block; background:none; border:none; color:#555; cursor:pointer;">Cancel</button>
  </div>
  
  
  <div id="commentPopup" style="display:none; position:fixed; bottom:0; left:0; right:0; background:white; padding:10px; border-top:1px solid #ccc; box-shadow:0 -2px 5px rgba(0,0,0,0.1); z-index:1000;">
    <div id="commentList" style="max-height:200px; overflow-y:auto; margin-bottom:10px;"></div>
    <input id="newComment" placeholder="Add a comment..." style="width:70%; padding:8px;">
    <button onclick="postComment()" style="padding:8px;">Post</button>
    <button onclick="closeCommentPopup()" style="float:right;">‚úñ</button>
  </div>
  <!-- Notifications Icon and Popup -->
  <div id="storyViewerOverlay" class="overlay" onclick="closeStoryViewer()"></div>
  <div id="storyViewer" class="story-viewer">
    <div id="storyMediaWrapper"></div>
    <div id="storyCaption" class="story-caption"></div>
  </div>
  
  <button onclick="showNotifications()" style="position:fixed;bottom:70px;left:10px;z-index:9999;font-size:24px;background:none;border:none;cursor:pointer;">
    üîî
  </button>
  
<div id="notifBox" style="
  display:none;
  position:fixed;
  top:50px;
  right:10px;
  width:280px;
  max-height:400px;
  overflow-y:auto;
  background:white;
  border-radius:10px;
  box-shadow:0 5px 20px rgba(0,0,0,0.3);
  padding:10px;
  z-index:9999;
  font-family:sans-serif;
">
  <strong style="font-size:18px;">Notifications</strong>
  <hr style="margin:8px 0;">
  <div id="notifContent">Loading...</div>
</div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAe0j-iB4gapzSq1zy2a6j4kwaET8JXZ_8",
      authDomain: "nopeeking-e272a.firebaseapp.com",
      databaseURL: "https://nopeeking-e272a-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "nopeeking-e272a",
      storageBucket: "nopeeking-e272a.firebasestorage.app",
      messagingSenderId: "193204663242",
      appId: "1:193204663242:web:46523ab13715b022b09533"
    };
    

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();
    const verifiedUsers = {
  "wQv32fQ848d2QOYWFl0JcJcLHmZ2": true,
  "H05KT1PoBgYBpAucIoLDjCfypCl2": true,
  "AuDjAuoM0nff0nBgMomSjO20lup2": true,

  
};
const verifiedBadge = '<img src="" style="width:14px;margin-left:-5px;margin-top:-5px;position:absolute;" title="Verified">';

    let currentUser = null;
    let viewingUID = null;
  
    auth.onAuthStateChanged(user => {
  currentUser = user;
  const loginSection = document.getElementById("loginSection");

  if (user) {
    loginSection.style.display = "none";
    document.getElementById("user-pic").innerHTML = `<img src="${user.photoURL || "https://via.placeholder.com/40?text=üë§"}" style="width:30px;height:30px;border-radius:50%;">`;

    db.ref("users/" + user.uid).once("value", snap => {
      if (!snap.exists()) {
        const name = prompt("Pick your username:");
        const defaultPic = user.photoURL || "https://via.placeholder.com/40?text=üë§";
        if (name) {
          db.ref("users/" + user.uid).set({
            name,
            bio: "",
            pic: defaultPic
          });
        }
      }
    });

    loadPosts();
    loadStories();
    loadStoryRings();
    cleanupOldStories();
  } else {
    loginSection.style.display = "block";
  }
});

function createPost() {
  const uploads = files.map(async file => {
  const isVideo = file.type.startsWith("video/");
  const isAudio = file.type.startsWith("audio/");
  const path = isVideo ? 'postVideos/' : isAudio ? 'postAudios/' : 'postImages/';
  const storageRef = storage.ref(path + Date.now() + '_' + file.name);
  const snapshot = await storageRef.put(file);
  const url = await snapshot.ref.getDownloadURL();

  if (isVideo) postData.videoUrls.push(url);
  else if (isAudio) postData.audioUrl = url;
  else postData.imageUrls.push(url);
});

  db.ref("users/" + currentUser.uid).once("value").then(snap => {
    const user = snap.val() || {};

    const postData = {
      uid: currentUser.uid,
      name: user.name || currentUser.displayName || "Anonymous",
      pic: user.pic || currentUser.photoURL || "https://via.placeholder.com/40?text=üë§",
      text,
      timestamp: Date.now(),
      likes: 0,
      comments: 0,
      hashtags: hashtags,
      imageUrls: [],
      videoUrls: []
    };

    const uploads = files.map(file => {
      const isVideo = file.type.startsWith("video/");
      const path = isVideo ? "postVideos/" : "postImages/";
      const storageRef = storage.ref(path + Date.now() + "_" + file.name);
      return storageRef.put(file)
        .then(snapshot => snapshot.ref.getDownloadURL())
        .then(url => {
          if (isVideo) {
            postData.videoUrls.push(url);
          } else {
            postData.imageUrls.push(url);
          }
        });
    });

    return Promise.all(uploads).then(() => db.ref("posts").push(postData));
  }).then(() => {
    document.getElementById("postInput").value = "";
    document.getElementById("postImage").value = "";
  }).catch(error => {
    alert("Upload failed: " + error.message);
  });
  document.getElementById("postInput").value = "";
document.getElementById("postImage").value = "";
loadPosts(); // üëà auto reload feed

}

  
function loadPosts() {
  db.ref("posts").once("value", snapshot => {
    const data = snapshot.val();
    const feed = document.getElementById("feed");
    feed.innerHTML = "";
    if (!data) return;

    const sortedPosts = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);

    sortedPosts.forEach(([postId, post]) => {
      db.ref("likes/" + postId).once("value", likeSnap => {
        const likeCount = likeSnap.numChildren();
        const isLiked = !!likeSnap.child(currentUser.uid).val();
        const likedClass = isLiked ? "liked" : "";
        const isVerified = verifiedUsers[post.uid];
        const verified = isVerified ? `<img src="https://cdn3d.iconscout.com/3d/premium/thumb/golden-verified-status-3d-icon-download-in-png-blend-fbx-gltf-file-formats--gold-approved-premium-pack-startup-icons-8796427.png" class="verified-icon">` : "";
        const canDelete = post.uid === currentUser.uid;
        const deleteBtn = canDelete ? `<span class="delete-btn" onclick="deletePost('${postId}')">üóëÔ∏è</span>` : "";
        const userPic = post.pic || "https://via.placeholder.com/40?text=üë§";

        // Images
        let imageHtml = "";
let videoHtml = "";

// If multiple images
if (Array.isArray(post.imageUrls) && post.imageUrls.length > 0) {
  const slides = post.imageUrls.map(url => `<img src="${url}" class="carousel-img">`).join('');
  imageHtml = `
    <div class="carousel">
      <div class="carousel-track">${slides}</div>
    </div>
  `;
}
if (post.audioUrl) {
  media += `<audio src="${post.audioUrl}" autoplay loop></audio>`;
}

// If multiple videos
if (Array.isArray(post.videoUrls) && post.videoUrls.length > 0) {
  videoHtml = post.videoUrls.map(url =>
    `<video src="${url}" controls class="post-img" style="max-height: 400px; border-radius: 10px; width: 100%; margin-top: 10px;"></video>`
  ).join('');
}
        // Followers ‚Üí Badges
        db.ref("follows").once("value", followSnap => {
          let followerCount = 0;
          const allFollows = followSnap.val() || {};
          Object.values(allFollows).forEach(f => {
            if (f[post.uid]) followerCount++;
          });

          let badgeUrl = "";
          if (followerCount >= 5000) {
            badgeUrl = "rainbow.png"; // rainbow
          } else if (followerCount >= 1000) {
            badgeUrl = "blue.png"; // blue
          } else if (followerCount >= 500) {
            badgeUrl = "red.png"; // red
          } else if (followerCount >= 1) {
            badgeUrl = "yellow.png"; // yellow
          }

          const badgeHtml = badgeUrl
            ? `<img src="${badgeUrl}" title="${followerCount} followers" style="width:20px;height:20px;margin-left:4px;">`
            : "";

          // Final post block
          const postBlock = `
  <div class="post">
    <div class="meta">
      <img src="${userPic}" onclick="viewUserProfile('${post.uid}')">
      <div>
        <strong>${post.name}${verified}${badgeHtml}</strong>
        <div class="mutual-followers" id="mutual-${postId}" style="font-size: 13px; color: #777;"></div>
      </div>
      ${deleteBtn}
    </div>
    <div>${formatPostText(post.text)}</div>
    ${imageHtml}
    ${videoHtml}
    <div class="stats">
      <span class="like-btn ${likedClass}" onclick="toggleLike('${postId}')">‚ô•</span>
      <span>${likeCount} like${likeCount !== 1 ? 's' : ''}</span>
      <span class="comment-btn" onclick="openCommentPopup('${postId}')">üí¨</span>
    </div>
  </div>
`;
feed.innerHTML += postBlock;

          

          getMutualFollowersText(post.uid, text => {
            const el = document.getElementById("mutual-" + postId);
            if (el) el.textContent = text;
          });

          setTimeout(() => enableSwipeCarousel(), 50);
        });
        cleanupOldStories();

      });
    });
  });
}


function formatPostText(text) {
  return text.replace(/#(\w+)/g, (match, tag) => {
    return `<span class="hashtag" onclick="searchHashtag('${tag}')">#${tag}</span>`;
  });
}
let currentCommentPostId = "";

function openCommentPopup(postId) {
  currentCommentPostId = postId;
  const popup = document.getElementById("commentPopup");
  popup.style.display = "block";
  const list = document.getElementById("commentList");
  list.innerHTML = "<em>Loading...</em>";

  db.ref("comments/" + postId).once("value", snap => {
    list.innerHTML = "";
    const comments = snap.val() || {};
    Object.entries(comments).forEach(([id, comment]) => {
      const avatar = comment.pic || "https://via.placeholder.com/40?text=üë§";
      list.innerHTML += `
        <div style="display:flex;gap:10px;margin-bottom:5px;">
          <img src="${avatar}" style="width:30px;height:30px;border-radius:50%;">
          <div>
            <strong>${comment.name}</strong><br>${comment.text}
          </div>
        </div>
      `;
    });
  });
}



function closeCommentPopup() {
  document.getElementById("commentPopup").style.display = "none";
}

    function searchPosts() {
  const term = document.getElementById("searchInput").value.trim().toLowerCase();
  db.ref("posts").once("value", snap => {
    const feed = document.getElementById("feed");
    feed.innerHTML = "";
    const data = snap.val();
    if (!data) return;

    const sorted = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);
    sorted.forEach(([id, post]) => {
      const hashtags = post.hashtags || [];
      const combinedText = (post.text || "").toLowerCase();
      const matches = combinedText.includes(term) || hashtags.includes(term);

      if (!term || matches) {
        const imgHtml = post.imageUrl ? `<img class="post-img" src="${post.imageUrl}" />` : "";
        const userPic = post.pic || "https://via.placeholder.com/40?text=üë§";
        const liked = ""; // Optional: update like state here

        feed.innerHTML += `
          <div class="post">
            <div class="meta">
              <img src="${userPic}" onclick="viewUserProfile('${post.uid}')">
              <strong>${post.name}</strong>
            </div>
            
            ${imgHtml}
            <div class="stats">
              <span class="like-btn ${liked}" onclick="toggleLike('${id}')">‚ô•</span>
              <span class="comment-btn">üí¨</span>
            </div>
          </div>`;
      }
    });
  });
}
function deletePost(postId) {
  if (confirm("Are you sure you want to delete this post?")) {
    db.ref("posts/" + postId).remove().then(() => {
      alert("Post deleted.");
    });
  }
}

function formatTextWithHashtags(text) {
  return text.replace(/#(\w+)/g, (match, tag) => {
    return `<span class="hashtag" onclick="searchHashtag('${tag.toLowerCase()}')">#${tag}</span>`;
  });
}

function searchHashtag(tag) {
  document.getElementById("searchInput").value = tag;
  searchPosts();
}

function toggleLike(postId) {
  const ref = db.ref("likes/" + postId + "/" + currentUser.uid);

  ref.once("value").then(snap => {
    if (snap.exists()) {
      // Unlike
      ref.remove().then(() => {
        updateLikeCount(postId);
        loadPosts(); // Optional: refresh UI
      });
    } else {
      // Like
      ref.set(true).then(() => {
        db.ref("posts/" + postId).once("value").then(postSnap => {
          const post = postSnap.val();
          if (post && post.uid !== currentUser.uid) {
            db.ref("notifications/" + post.uid).push({
              type: "like",
              from: currentUser.uid,
              postId,
              timestamp: Date.now()
            });
          }
        });
        updateLikeCount(postId);
        loadPosts(); // Optional
      });
    }
  });
}




  
    function uploadStory() {
      const file = document.getElementById("storyFile").files[0];
      const overlay = document.getElementById("storyOverlay").value;
  
      if (!file) return alert("Choose a file to upload.");
  
      const fileType = file.type.startsWith("video/") ? "video" : "image";
      const ref = storage.ref("stories/" + Date.now() + "_" + file.name);
  
      ref.put(file).then(snap => snap.ref.getDownloadURL()).then(url => {
        db.ref("users/" + currentUser.uid).once("value", snap => {
          const user = snap.val() || {};
          db.ref("times/" + currentUser.uid).set({
            media: url,
            type: fileType,
            overlay,
            timestamp: Date.now(),
            name: user.name || "You",
            pic: user.pic || "https://via.placeholder.com/60?text=üë§"
          }).then(() => {
            document.getElementById("storyFile").value = "";
            document.getElementById("storyOverlay").value = "";
            loadStories();
            loadStoryRings();
            alert("Story uploaded!");
          });
        });
      });
    }
    function extractHashtags(text) {
  const matches = text.match(/#\w+/g);
  return matches ? matches.map(tag => tag.toLowerCase()) : [];
}

    function loadStories() {
      db.ref("times").once("value", snap => {
        const stories = document.getElementById("stories");
        stories.innerHTML = "";
        const times = snap.val();
        if (!times) return;
        Object.entries(times).forEach(([uid, time]) => {
          const storyPic = time.pic || "https://via.placeholder.com/60?text=üë§";
          stories.innerHTML += `<div class="story" onclick="showTime('${time.media}', '${time.type}', '${time.overlay}', '${uid}')">
            <img src="${storyPic}">
            <div class="username">${time.name}</div>
          </div>`;
        });
      });
    }
    

    function loadStoryRings() {
  db.ref("follows/" + currentUser.uid).once("value", snap => {
    const following = snap.val() || {};
    db.ref("users").once("value", userSnap => {
      const allUsers = userSnap.val() || {};
      const rings = document.getElementById("storyRings");
      rings.innerHTML = "";

      Object.keys(following).forEach((uid, i) => {
        const user = allUsers[uid];
        if (!user) return;
        const color = ["blue", "red", "orange", "purple"][i % 4];
        const ringPic = user.pic || "https://via.placeholder.com/60?text=üë§";
        const badge = verifiedUsers[uid] ? verifiedBadge : "";
        rings.innerHTML += `
          <div class="story-ring ${color}" onclick="viewUserProfile('${uid}')">
            <img src="${ringPic}">${badge}
          </div>`;
      });
    });
  });
}

  
    function showTime(url, type, overlay, ownerUid) {
      if (ownerUid && currentUser.uid !== ownerUid) {
        db.ref(`times/${ownerUid}/viewers/${currentUser.uid}`).set(true);
      }
      const win = window.open("", "_blank");
      if (type === "video") {
        win.document.write(`<video src="${url}" controls autoplay style="width:100%"></video><p>${overlay || ''}</p>`);
      } else {
        win.document.write(`<img src="${url}" style="width:100%"><p>${overlay || ''}</p>`);
      }
    }
  
    function viewUserProfile(uid) {
      viewingUID = uid;
      document.getElementById("profilePage").style.display = "block";
      document.getElementById("feed").style.display = "none";
  
      db.ref("users/" + uid).once("value", snap => {
        const data = snap.val();
        document.getElementById("profileName").innerText = data?.name || "User";
        document.getElementById("profileBio").innerText = data?.bio || "";
      });
  
      db.ref("follows").once("value", snap => {
        const all = snap.val() || {};
        let count = 0;
        Object.values(all).forEach(f => { if (f[uid]) count++; });
        document.getElementById("followerCount").innerHTML = `${count} Followers ${getFollowerBadgeImage(count)}`;


      });
      

      db.ref("posts").orderByChild("uid").equalTo(uid).once("value", snap => {
        const posts = snap.val();
        const box = document.getElementById("profilePosts");
        box.innerHTML = "<h3>Posts</h3>";
        if (posts) {
          Object.values(posts).reverse().forEach(p => {
            const postImage = p.imageUrl ? `<img class="post-img" src="${p.imageUrl}">` : "";
            box.innerHTML += `<div class='post'>
              <div class='meta'>
                <img src='${p.pic || "https://via.placeholder.com/40?text=üë§"}'/>
                <strong>${p.name}</strong>
              </div>
              <div>${p.text}</div>
              ${postImage}
            </div>`;
          });
        } else {
          box.innerHTML += "<p>No posts</p>";
        }
      });
      const file = document.getElementById("postImage").files[0];
if (file) {
  resizeImage(file).then(resizedBlob => {
    const storageRef = storage.ref("postImages/" + Date.now() + "_" + file.name);
    storageRef.put(resizedBlob)
      .then(snapshot => snapshot.ref.getDownloadURL())
      .then(url => {
        postData.imageUrl = url;
        db.ref("posts").push(postData);
      });
  });
}

      const btn = document.getElementById("followBtn");
      if (uid === currentUser.uid) {
        btn.style.display = "none";
      } else {
        btn.style.display = "inline-block";
        db.ref("follows/" + currentUser.uid + "/" + uid).once("value", snap => {
          btn.innerText = snap.exists() ? "Unfollow" : "Follow";
        });
      }
    }
  
    function toggleFollow() {
  const ref = db.ref("follows/" + currentUser.uid + "/" + viewingUID);

  ref.once("value", snap => {
    if (snap.exists()) {
      // Unfollow
      ref.remove();
      document.getElementById("followBtn").innerText = "Follow";
    } else {
      // Follow
      ref.set(true).then(() => {
        document.getElementById("followBtn").innerText = "Unfollow";
        db.ref("notifications/" + viewingUID).push({
          type: "follow",
          from: currentUser.uid,
          timestamp: Date.now()
        });
      });
    }
  });
}

  
    function closeProfile() {
      document.getElementById("profilePage").style.display = "none";
      document.getElementById("feed").style.display = "block";
    }
  
    function cleanupOldStories() {
      const now = Date.now();
      db.ref("times").once("value", snap => {
        const stories = snap.val();
        if (!stories) return;
        Object.entries(stories).forEach(([uid, story]) => {
          if (story.timestamp && now - story.timestamp > 24 * 60 * 60 * 1000) {
            db.ref("times/" + uid).remove();
          }
        });
      });
    }
    
    function openEditor() {
      db.ref("users/" + currentUser.uid).once("value").then(snap => {
        const user = snap.val() || {};
        document.getElementById("editName").value = user.name || "";
        document.getElementById("editBio").value = user.bio || "";
        document.getElementById("profileEditor").style.display = "block";
        document.getElementById("editorOverlay").style.display = "block";
      });
    }

    function closeEditor() {
      document.getElementById("profileEditor").style.display = "none";
      document.getElementById("editorOverlay").style.display = "none";
    }

    function saveProfileEdits() {
      const name = document.getElementById("editName").value;
      const bio = document.getElementById("editBio").value;
      const file = document.getElementById("editPic").files[0];

      if (!name) return alert("Username is required.");

      const updates = { name, bio };

      if (file) {
        const ref = storage.ref("profilePics/" + currentUser.uid + "_" + Date.now());
        ref.put(file)
          .then(snap => snap.ref.getDownloadURL())
          .then(url => {
            updates.pic = url;
            return db.ref("users/" + currentUser.uid).update(updates);
          })
          .then(() => {
            alert("Profile updated!");
            closeEditor();
            location.reload();
          });
      } else {
        db.ref("users/" + currentUser.uid).update(updates).then(() => {
          alert("Profile updated!");
          closeEditor();
          location.reload();
        });
      }
    }
    auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById("loginModal").style.display = "none";
      loadStoryRings();
    } else {
      document.getElementById("loginModal").style.display = "flex";
    }
  });

  function loginWithEmail() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    auth.signInWithEmailAndPassword(email, password).catch(alert);
  }

  function signUpWithEmail() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    auth.createUserWithEmailAndPassword(email, password).catch(alert);
  }

  function loginWithGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(err => alert("Login failed: " + err.message));
}

    const storageRef = firebase.app().storage("gs://nopeeking-e272a.firebasestorage.app").ref("postImages/" + file.name)
storageRef.put(file)
  .then(snapshot => snapshot.ref.getDownloadURL())
  .then(url => {
    // save the URL to your database
  });
  function resizeImage(file, maxSize = 1024) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = function (event) {
      const img = new Image();
      img.onload = function () {
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > maxSize) {
            height *= maxSize / width;
            width = maxSize;
          }
        } else {
          if (height > maxSize) {
            width *= maxSize / height;
            height = maxSize;
          }
        }

        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);

        canvas.toBlob(resolve, file.type, 0.9); // 0.9 = quality
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  });
}
// RENDER COMMENTS
function renderComments(postId, container) {
  db.ref("comments/" + postId).once("value", snap => {
    const data = snap.val();
    if (!data) return;
    Object.entries(data).forEach(([commentId, comment]) => {
      const div = document.createElement("div");
      div.className = "comment";
      const userPic = comment.pic || "https://via.placeholder.com/30";
      div.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
          <img src="${userPic}" style="width:30px;height:30px;border-radius:50%;">
          <strong>${comment.name}</strong>: ${comment.text}
        </div>
      `;
      container.appendChild(div);
    });
  });
}

// POST A COMMENT

// MUTUAL FOLLOWERS TEXT (e.g. ‚ÄúFollowed by Leo & 2 others‚Äù)
function getMutualFollowersText(targetUid, callback) {
  db.ref("follows/" + targetUid).once("value", snap => {
    const targetFollowers = snap.val() || {};
    db.ref("follows/" + currentUser.uid).once("value", mySnap => {
      const myFollows = mySnap.val() || {};
      const mutuals = Object.keys(targetFollowers).filter(uid => myFollows[uid]);
      if (mutuals.length === 0) return callback("");
      const displayNames = [];
      let count = 0;
      const limit = 3;
      mutuals.slice(0, limit).forEach(uid => {
        db.ref("users/" + uid).once("value", userSnap => {
          displayNames.push(userSnap.val()?.name || "Someone");
          count++;
          if (count === Math.min(mutuals.length, limit)) {
            const others = mutuals.length - displayNames.length;
            const extra = others > 0 ? ` & ${others} other${others > 1 ? "s" : ""}` : "";
            callback("Followed by " + displayNames.join(", ") + extra);
          }
        });
      });
    });
  });
}


function toggleComments() {
    const popup = document.getElementById("commentPopup");
    popup.style.display = popup.style.display === "block" ? "none" : "block";
  } function postComment() {
    const text = document.getElementById("commentInput").value;
    const list = document.getElementById("commentsList");
    if (text.trim() === "") return;
    const item = document.createElement("div");
    item.innerText = text;
    list.appendChild(item);
    document.getElementById("commentInput").value = "";
  }
  window.addEventListener("scroll", () => {
    document.getElementById("commentPopup").style.display = "none";
  });
  function showMutualFollowers(postId, targetUid) {
  const mutualContainer = document.getElementById("mutual-" + postId);
  if (!currentUser || !mutualContainer) return;

  db.ref("follows/" + targetUid).once("value", snap => {
    const theirFollowers = snap.val() || {};

    db.ref("follows/" + currentUser.uid).once("value", mySnap => {
      const myFollows = mySnap.val() || {};

      const mutuals = Object.keys(theirFollowers).filter(uid => myFollows[uid]);
      if (mutuals.length === 0) return;

      const names = [];
      const promises = mutuals.slice(0, 2).map(uid =>
        db.ref("users/" + uid).once("value").then(userSnap => {
          const name = userSnap.val()?.name;
          if (name) names.push(name);
        })
      );

      Promise.all(promises).then(() => {
        let text = "Followed by " + names.join(" & ");
        if (mutuals.length > 2) {
          text += ` & ${mutuals.length - 2} others`;
        }
        mutualContainer.innerText = text;
      });
    });
  });
}
showMutualFollowers(postId, post.uid);
function enableSwipeCarousel() {
  const carousels = document.querySelectorAll(".carousel-track");

  carousels.forEach(track => {
    let startX = 0;
    let currentTranslate = 0;

    track.addEventListener("touchstart", e => {
      startX = e.touches[0].clientX;
    });

    track.addEventListener("touchmove", e => {
      if (!startX) return;
      let diff = startX - e.touches[0].clientX;
      if (Math.abs(diff) > 50) {
        const direction = diff > 0 ? 1 : -1;
        const width = track.offsetWidth;
        currentTranslate += direction * width;
        currentTranslate = Math.max(Math.min(currentTranslate, (track.childElementCount - 1) * width), 0);
        track.style.transform = `translateX(-${currentTranslate}px)`;
        startX = 0;
      }
    });
  });
}
function openGroupApp() {
  document.getElementById("groupAppScreen").style.display = "block";
}

function closeGroupApp() {
  document.getElementById("groupAppScreen").style.display = "none";
}

function autoScrollCarousels() {
  document.querySelectorAll(".post-carousel").forEach(carousel => {
    let scrollPos = 0;
    const interval = setInterval(() => {
      scrollPos += carousel.clientWidth;
      if (scrollPos >= carousel.scrollWidth) {
        scrollPos = 0;
      }
      carousel.scrollTo({ left: scrollPos, behavior: 'smooth' });
    }, 3000);
  });
}
function autoScrollCarousels() {
  document.querySelectorAll(".post-carousel").forEach(carousel => {
    let scrollAmount = 0;
    const interval = setInterval(() => {
      if (carousel.scrollLeft + carousel.clientWidth >= carousel.scrollWidth - 5) {
        scrollAmount = 0;
      } else {
        scrollAmount += carousel.clientWidth;
      }
      carousel.scrollTo({ left: scrollAmount, behavior: 'smooth' });
    }, 3000);
  });
}

// run after posts are loaded
setTimeout(autoScrollCarousels, 1500);

// Call after posts are loaded
setTimeout(autoScrollCarousels, 1500);
function enableSwipeCarousel() {
  document.querySelectorAll('.carousel-track').forEach(track => {
    let index = 0;
    const scroll = () => {
      const children = track.children;
      if (children.length > 1) {
        index = (index + 1) % children.length;
        track.scrollTo({
          left: children[index].offsetLeft,
          behavior: 'smooth'
        });
      }
    };
    setInterval(scroll, 3000); // auto scroll every 3s
  });
}

function getFollowerBadgeImage(followerCount) {
  if (followerCount >= 10000) return `<img src="${badges.eren}" title="Eren Titan Badge" style="height:18px;margin-left:5px;">`;
  if (followerCount >= 1000) return `<img src="${badges.elite}" title="Elite Badge" style="height:18px;margin-left:5px;">`;
  if (followerCount >= 100) return `<img src="${badges.beginner}" title="Beginner Badge" style="height:18px;margin-left:5px;">`;``

  return "";
}
function openMoooods() {
  document.getElementById("moooodsScreen").style.display = "block";
  loadMoooods();

  setTimeout(() => {
    scrollToSharedMooood();
  }, 600); // let DOM render
}


function closeMoooods() {
  document.getElementById("moooodsScreen").style.display = "none";
  document.getElementById("moooodsContainer").innerHTML = "";
}

function loadMoooods(callback = () => {}) {
  const container = document.getElementById("moooodsContainer");
  container.innerHTML = "";

  db.ref("posts").once("value", snap => {
    const posts = snap.val();
    if (!posts) return;

    Object.entries(posts).reverse().forEach(([id, post]) => {
      let media = "";

      if (Array.isArray(post.imageUrls)) {
        post.imageUrls.forEach(url => {
          media += `<img src="${url}" class="mood-media" />`;
        });
      }

      if (Array.isArray(post.videoUrls)) {
        post.videoUrls.forEach(url => {
          media += `<video src="${url}" class="mood-media custom-video" loop playsinline></video>`;
        });
      }

      if (!media && post.imageUrl) {
        media = `<img src="${post.imageUrl}" class="mood-media" />`;
      }

      const userPic = post.pic || "https://via.placeholder.com/40?text=üë§";
      const username = post.name || "Unknown";

      const textOverlay = (!media && post.text)
        ? `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: black; padding: 16px 20px; border-radius: 16px; font-size: 18px; max-width: 90%; text-align: center;">${formatPostText(post.text)}</div>`
        : "";

      container.innerHTML += `
        <div id="mooood-${id}" style="height:100vh;width:100%;scroll-snap-align:start;position:relative;">
          ${media}
          <div style="position:absolute;top:15px;left:15px;display:flex;align-items:center;gap:8px;color:white;text-shadow:0 0 5px black;">
            <img src="${userPic}" style="width:40px;height:40px;border-radius:50%;border:2px solid white;" />
            <div style="font-weight:bold;">${username}</div>
          </div>
          ${textOverlay}
          <div style="position:absolute;right:15px;bottom:80px;display:flex;flex-direction:column;align-items:center;gap:20px;">
            <span class="mood-like" data-id="${id}" style="font-size:24px;cursor:pointer;">ü§ç</span>
            <span class="mood-likes-count" id="likes-count-${id}" style="color:white;font-size:14px;text-shadow:0 0 4px black;">0</span>
            <span class="mood-comment-btn" data-id="${id}" style="font-size:24px;cursor:pointer;">üí¨</span>
            <span class="mood-share-btn" data-id="${id}" style="font-size:24px;cursor:pointer;">üîó</span>
          </div>
        </div>
      `;

      db.ref("likes/" + id).once("value", snap => {
        const count = snap.numChildren();
        document.getElementById("likes-count-" + id).innerText = count;
        if (snap.hasChild(currentUser.uid)) {
          document.querySelector(`.mood-like[data-id="${id}"]`).textContent = "‚ù§Ô∏è";
        }
      });
    });

    setTimeout(() => {
      enableCustomVideoControls();
      enableMoooodLikes();
      enableMoooodComments();
      enableMoooodShare();
      callback(); // üëà invoke callback after rendering
    }, 300);
  });
}

function scrollToSharedMooood() {
  const hash = window.location.hash;
  if (hash.startsWith("#mooood-")) {
    const targetId = hash.replace("#", "");
    const target = document.getElementById(targetId);
    if (target) {
      document.getElementById("moooodsScreen").style.display = "block";
      target.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  }
}

function formatPostText(text) {
  return (text || "").replace(/#(\w+)/g, (match, tag) => {
    return `<span class="hashtag" onclick="searchHashtag('${tag}')">#${tag}</span>`;
  });
}



function enableCustomVideoControls() {
  const videos = document.querySelectorAll(".custom-video");

  videos.forEach(video => {
    video.pause();
    video.addEventListener("click", () => {
      videos.forEach(v => { if (v !== video) v.pause(); });
      if (video.paused) {
        video.play().catch(err => console.warn("Play failed:", err));
      } else {
        video.pause();
      }
    });
  });
}



function enableMoooodLikes() {
  document.querySelectorAll(".mood-like").forEach(btn => {
    const postId = btn.dataset.id;

    btn.addEventListener("click", () => {
      const ref = db.ref("likes/" + postId + "/" + currentUser.uid);
      ref.once("value", snap => {
        if (snap.exists()) {
          ref.remove().then(() => {
            btn.textContent = "ü§ç";
            updateLikeCount(postId);
          });
        } else {
          ref.set(true).then(() => {
            btn.textContent = "‚ù§Ô∏è";
            updateLikeCount(postId);
          });
        }
      });
    });
  });
}

function updateLikeCount(postId) {
  db.ref("likes/" + postId).once("value", snap => {
    const count = snap.numChildren();
    document.getElementById("likes-count-" + postId).innerText = count;
  });
}

function enableMoooodComments() {
  document.querySelectorAll(".mood-comment-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const postId = btn.dataset.id;
      openCommentPopup(postId);
    });
  });
}
function goToFeed() {
  document.getElementById("feed").style.display = "block";
  document.getElementById("profilePage").style.display = "none";
  document.getElementById("moooodsScreen").style.display = "none";
}

// üëà Declare this first!
let currentSharePostId = null;
function enableMoooodShare() {
  document.querySelectorAll(".mood-share-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const postId = btn.dataset.id;
      const link = `${location.origin}#mooood-${postId}`;

      navigator.clipboard.writeText(link).then(() => {
        alert("Link copied!");

        // üëá Go to Moooods screen and scroll to post
        document.getElementById("moooodsScreen").style.display = "block";

        // Wait for Moooods to load, then scroll
        loadMoooods(() => {
          const target = document.getElementById(`mooood-${postId}`);
          if (target) {
            setTimeout(() => {
              target.scrollIntoView({ behavior: "smooth", block: "center" });
            }, 400);
          }
        });
      });
    });
  });
}




function closeSharePopup() {
  const popup = document.getElementById("sharePopup");
  popup.classList.remove("show");
}

function copyShareLink() {
  if (!currentSharePostId) return;
  const link = `${location.origin}?post=${currentSharePostId}`;
  navigator.clipboard.writeText(link).then(() => {
    alert("Link copied!");
    closeSharePopup();
  });
}

setTimeout(enableMoooodShare, 500);

function scrollToSharedMooood() {
  const hash = window.location.hash;
  if (hash && hash.startsWith("#mooood-")) {
    const id = hash.replace("#mooood-", "");
    const target = document.getElementById("mooood-" + id);
    if (target) {
      document.getElementById("moooodsScreen").style.display = "block";
      target.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  }
}

// Run after Moooods are loaded
setTimeout(() => {
  loadMoooods();
  setTimeout(scrollToSharedMooood, 500);
}, 500);

function showNotifications() {
  const box = document.getElementById("notifBox");
  const content = document.getElementById("notifContent");

  box.style.display = box.style.display === "block" ? "none" : "block";
  content.innerHTML = "Loading...";

  db.ref("notifications/" + currentUser.uid)
    .orderByChild("timestamp")
    .limitToLast(20)
    .once("value", snap => {
      const data = snap.val();
      if (!data) return content.innerHTML = "<p>No notifications yet.</p>";

      content.innerHTML = "";
      const items = Object.entries(data).reverse();

      items.forEach(([id, notif]) => {
        let message = "";
        if (notif.type === "like") {
          message = `‚ù§Ô∏è Someone liked your post.`;
        } else if (notif.type === "follow") {
          message = `‚ûï Someone followed you.`;
        }

        content.innerHTML += `<div style="margin-bottom:8px;font-size:14px;">${message}</div>`;
      });
    });
}

function uploadStory() {
  const file = document.getElementById("storyFile").files[0];
  const overlay = document.getElementById("storyOverlay").value;

  if (!file) return alert("Choose a file first!");

  const fileType = file.type.startsWith("video/") ? "video" : "image";
  const ref = storage.ref("stories/" + Date.now() + "_" + file.name);

  ref.put(file).then(snap => snap.ref.getDownloadURL()).then(url => {
    db.ref("users/" + currentUser.uid).once("value", snap => {
      const user = snap.val() || {};
      db.ref("times/" + currentUser.uid).set({
        media: url,
        type: fileType,
        overlay,
        timestamp: Date.now(),
        name: user.name || "You",
        pic: user.pic || "https://via.placeholder.com/60?text=üë§"
      }).then(() => {
        alert("Story uploaded!");
        document.getElementById("storyFile").value = "";
        document.getElementById("storyOverlay").value = "";
        loadStories();
        loadStoryRings();
      });
    });
  }).catch(err => {
    alert("Upload failed: " + err.message);
  });
}

function loadStoryRings() {
  db.ref("follows/" + currentUser.uid).once("value", snap => {
    const following = snap.val() || {};
    db.ref("users").once("value", userSnap => {
      const allUsers = userSnap.val() || {};
      const rings = document.getElementById("storyRings");
      rings.innerHTML = "";

      Object.keys(following).forEach((uid, i) => {
        const user = allUsers[uid];
        if (!user) return;
        const ringPic = user.pic || "https://via.placeholder.com/60?text=üë§";
        rings.innerHTML += `
          <div class="story-ring blue" onclick="viewStory('${uid}')">
            <img src="${ringPic}">
          </div>`;
      });
    });
  });
}
function viewStory(uid) {
  db.ref("times/" + uid).once("value", snap => {
    const story = snap.val();
    if (!story) return;

    if (uid !== currentUser.uid) {
      db.ref("times/" + uid + "/viewers/" + currentUser.uid).set(true);
    }

    const mediaTag = story.type === "video"
      ? `<video src="${story.media}" autoplay controls style="width:100%"></video>`
      : `<img src="${story.media}" style="width:100%">`;

    const overlay = story.overlay || "";

    const win = window.open("", "_blank");
    win.document.write(`${mediaTag}<p>${overlay}</p>`);
  });
}
function cleanupOldStories() {
  const now = Date.now();
  db.ref("times").once("value", snap => {
    const stories = snap.val();
    if (!stories) return;

    Object.entries(stories).forEach(([uid, story]) => {
      if (story.timestamp && now - story.timestamp > 24 * 60 * 60 * 1000) {
        db.ref("times/" + uid).remove();
      }
    });
  });
}
function openStoryPopup() {
  document.getElementById("storyPopup").classList.add("show");
  document.getElementById("storyPopupOverlay").style.display = "block";
}

function closeStoryPopup() {
  document.getElementById("storyPopup").classList.remove("show");
  document.getElementById("storyPopupOverlay").style.display = "none";
}function openStoryPopup() {
  document.getElementById("storyPopup").style.display = "flex";
  document.getElementById("storyPopupOverlay").style.display = "block";
}

function closeStoryPopup() {
  document.getElementById("storyPopup").style.display = "none";
  document.getElementById("storyPopupOverlay").style.display = "none";
  document.getElementById("storyPreview").innerHTML = "";
  document.getElementById("previewCaption").innerText = "";
}

function previewStoryMedia(event) {
  const file = event.target.files[0];
  const preview = document.getElementById("storyPreview");
  preview.innerHTML = "";
  if (!file) return;

  const url = URL.createObjectURL(file);
  const isVideo = file.type.startsWith("video/");
  const element = isVideo
    ? `<video src="${url}" autoplay muted loop playsinline></video>`
    : `<img src="${url}" />`;
  preview.innerHTML = element + `<span class="caption-overlay" id="previewCaption"></span>`;
}

function updateCaptionPreview() {
  document.getElementById("previewCaption").innerText = document.getElementById("storyOverlay").value;
}
function showTime(url, type, overlay, ownerUid) {
  if (ownerUid && currentUser.uid !== ownerUid) {
    db.ref(`times/${ownerUid}/viewers/${currentUser.uid}`).set(true);
  }

  const wrapper = document.getElementById("storyMediaWrapper");
  const caption = document.getElementById("storyCaption");

  wrapper.innerHTML = type === "video"
    ? `<video src="${url}" autoplay muted controls playsinline style="max-height: 100%; max-width: 100%;"></video>`
    : `<img src="${url}" style="max-height: 100%; max-width: 100%;">`;

  caption.innerText = overlay || "";

  document.getElementById("storyViewer").style.display = "flex";
  document.getElementById("storyViewerOverlay").style.display = "block";
}

// Full logic for story viewing with double-click navigation between users

let allStories = []; // [ [uid, storyData], ... ]
let currentUserIndex = 0;

// Load and sort stories
function loadStoriesForViewer() {
  db.ref("times").once("value", snap => {
    const times = snap.val() || {};
    allStories = Object.entries(times).sort((a, b) => b[1].timestamp - a[1].timestamp);
  });
}

// Show specific story by index
function showTimeByIndex(userIdx) {
  if (!allStories[userIdx]) return;

  currentUserIndex = userIdx;

  const [uid, story] = allStories[userIdx];
  const url = story.media;
  const type = story.type;
  const overlay = story.overlay;

  if (uid && currentUser.uid !== uid) {
    db.ref(`times/${uid}/viewers/${currentUser.uid}`).set(true);
  }

  const wrapper = document.getElementById("storyMediaWrapper");
  const caption = document.getElementById("storyCaption");

  wrapper.innerHTML = type === "video"
    ? `<video src="${url}" autoplay muted controls playsinline style="max-height: 100%; max-width: 100%;"></video>`
    : `<img src="${url}" style="max-height: 100%; max-width: 100%;">`;

  caption.innerText = overlay || "";

  document.getElementById("storyViewer").style.display = "flex";
  document.getElementById("storyViewerOverlay").style.display = "block";
}

// Close viewer
function closeStoryViewer() {
  document.getElementById("storyViewer").style.display = "none";
  document.getElementById("storyViewerOverlay").style.display = "none";
  document.getElementById("storyMediaWrapper").innerHTML = "";
  document.getElementById("storyCaption").innerText = "";
}

// Handle double-tap to go next
function setupStoryViewerDblClick() {
  document.getElementById("storyViewer").addEventListener("dblclick", () => {
    currentUserIndex++;
    if (currentUserIndex < allStories.length) {
      showTimeByIndex(currentUserIndex);
    } else {
      closeStoryViewer();
    }
  });
}

  </script>
  
</body>
</html>
